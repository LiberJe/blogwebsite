var mongoose=require("mongoose");


mongoose.connect("mongodb://localhost/articles");
var db=mongoose.connection;

db.on("error",function(){
    console.error("connection error:");
})

console.log("db has connected");

var articlesSchema=mongoose.Schema({
    id:{type:String},
    title:{type:String},
    type:{type:String},
    date:{type:String},
    content:{type:String},
    description:{type:String}
})

var articles=mongoose.model("articles",articlesSchema);


function queryall(res){
    articles.find(function(error,data) {
        if(error){
            console.error(error);
        }else{
            res.writeHead(200,{'Content-Type': 'application/json'});
            res.end(JSON.stringify(data),"utf-8");
        }
    })
}   
    
function delData(req,res) {
    var deldata="";
    req.on("data",function(data){
        deldata+=data;
    })
    req.on("end",function(data){
        var val=JSON.parse(deldata);
        var condition={
            id:val.id
        }
        articles.remove(condition,function(error,data){
            if(error){
                console.log(error);
            }else{
                var dpdata={"check":true}
                res.writeHead(200,{"Content-Type":"application/json"});
                res.end(JSON.stringify(dpdata),"utf-8")
            }
        })
    })
}

function update(req,res) {
    var updation="";
    req.on("data",function(data){
        updation+=data;
    })
    req.on("end",function(data){
        var val=JSON.parse(updation);
        var condition={
            id:val.id
        }
        var update={
            $set:{
                content:val.content,
                type:val.type
            }
        }
        articles.update(condition,update,function(error,data){
            if(error){
                console.log(error);
            }else{
                var dpdata={"check":true}
                res.writeHead(200,{"Content-Type":"application/json"});
                res.end(JSON.stringify(dpdata),"utf-8")
            }
        })
    })
}

function create(req,res){
    var addtion="";
    req.on("data",function(data){
        addtion+=data;
    })
    req.on("end",function(data){
        var val=JSON.parse(addtion);
        
        articles.find(function(err,data){
            var id=data.length;
            var value={
                id:id+"",
                titile:val.title,
                type:val.type,
                date:val.date,
                content:val.content,
                description:val.description
            }
            
            articles.create(value,function(error,data){
                if(error){
                    console.log(error);
                }else{
                    var dpdata={"check":true}
                    res.writeHead(200,{"Content-Type":"application/json"});
                    res.end(JSON.stringify(dpdata),"utf-8")
                }
            })
        })
    })
}

exports.queryall=queryall;
exports.delData=delData;
exports.update=update;
exports.create=create;

// var mysql=require("mysql");
// var connection = mysql.createConnection({
//   host     : 'localhost',
//   user     : 'root',
//   password : '123',
//   database : 'website'
// });

// connection.connect();



// function queryall(res) {
//     connection.query('SELECT 1 + 1 AS solution', function(err, rows, fields) {
//         if (err) throw err;

//         console.log('The solution is: ', rows[0].solution);
//     });

//     connection.end();
// }

